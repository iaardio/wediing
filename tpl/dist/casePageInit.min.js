define("cases/createSite",["lib/utils/comUtils","lib/weui/picker","cases/createOrder"],function(i){function e(i){i=$.extend({editBtn:".wqj-edit-btn",editTooBars:".edit-tool-bars",createBtn:".buy-template",collectBtn:".not-collect"},i),e._init.call(this,i)}var a=i("lib/utils/comUtils"),o=i("lib/weui/picker"),c=i("cases/createOrder"),t='<div class="wqj-select-comfirm select-tpls"><div class="weui-mask weui-animate-fade-in"></div><div class="weui-picker weui-animate-slide-up "><div class="weui-actionsheet__menu select-btns"><div class="weui-actionsheet__cell title">您存在一个未发布请柬，是否替换该模板？</div><div class="weui-actionsheet__cell replace">替换该模板</div><div class="weui-actionsheet__cell continue">继续编辑原模板</div></div><div class="weui-actionsheet__action"><div class="weui-actionsheet__cell reset">取消</div></div></div></div>';return e.fn=e.prototype,e._init=function(i){var e=this;this.$edtiBtn=$(i.editBtn),this.$editTooBars=$(i.editTooBars),this.$edtiBtn.on("click",function(){e.$editTooBars.fadeIn(),$(this).fadeOut()}),this.$editTooBars.find(".weui-mask").on("click",function(){e.$editTooBars.fadeOut(),e.$edtiBtn.fadeIn()}),this.$createBtn=$(i.createBtn),this.$collectBtn=$(i.collectBtn),this.schemecode=this.$createBtn.attr("schemecode"),this.casecode=this.$createBtn.attr("casecode"),this.canCreateOrder=!0;var e=this;this.$createBtn.on("click",function(){e.canCreateOrder&&e.createFromCase(e.casecode,e.schemecode)}),this.$collectBtn.on("click",function(){a.Loading.show("加载中"),a.ajax.postJSON("/ci/wx/case/collectcase",{casecode:e.casecode},function(i){a.Loading.hide(),200===i.ecode?e.$collectBtn.off("click").find(".collect-img").attr("src","/mobiedit/wx/img/has-collect.png"):401===i.ecode?a.ConfirmDialog.show({title:"确认操作",content:"收藏模板需先登录，是否登录系统？",cancelTex:"取消",okTex:"确定",okFun:function(){e.goToLogin()}}):a.Toast.show("info",i.msg)})})},e.fn.goToLogin=function(){var i="/wx/edit/case.do?casecode="+this.casecode;window.location.href="/wx/auth.do?backUrl="+encodeURIComponent(i)},e.fn.changeFromCase=function(i,e){var o={casecode:i,sitecode:e};a.Loading.show("加载中"),a.ajax.postJSON("/front/tpl/changecase",o,function(i){if(a.Loading.hide(),200===i.ecode){var e=i.data;window.location.href="/wx/edit/index.do?sitecode="+e.sitecode}else a.Toast.show("info",i.msg)})},e.fn.createFromCase=function(i,e){var s=this,n={casecode:i,schemecode:e};s.canCreateOrder=!1,a.Loading.show("加载中"),a.ajax.RESTful("/ci/wx/case/createsite","POST",n,function(e){if(a.Loading.hide(),200===e.ecode){var n=e.data;if("0"==n.tailor)window.location.href="/wx/edit/index.do?sitecode="+n.sitecode;else{var d=n.sitecode;c.init(d)}}else if(401===e.ecode)s.goToLogin();else{var l=e.data.list[0];console.info(l),s.selectpicker=new o({pickerTpl:t,hideback:function(){}}),s.selectpicker.show();var r=s.selectpicker.getCurDom();r.find(".replace").on("click",function(){s.changeFromCase(i,l.sitecode)}),r.find(".continue").on("click",function(){window.location.href="/wx/edit/index.do?sitecode="+l.sitecode})}s.canCreateOrder=!0})},e.fn.changeFromCase=function(i,e){var o={casecode:i,sitecode:e};a.Loading.show("加载中"),a.ajax.postJSON("/ci/wx/case/changecase",o,function(i){if(a.Loading.hide(),200===i.ecode){var e=i.data;window.location.href="/wx/edit/index.do?sitecode="+e.sitecode}else a.Toast.show("info",i.msg)})},{init:function(i){var a=new e(i);return a}}}),define("cases/createOrder",["lib/utils/comUtils","lib/weui/picker"],function(i){function e(){}var a=i("lib/utils/comUtils"),o=i("lib/weui/picker"),c='<div class="wqj-select-comfirm wqj-to-pay"><div class="weui-mask weui-animate-fade-in"></div><div class="weui-picker weui-animate-slide-up "><div class="weui-actionsheet__menu select-btns"><div class="weui-actionsheet__cell"paycode="2082"><img class="icon-pay"src="/mobiedit/wx/img/pay/wechat.png"><span class="pay-title">&nbsp;微信支付</span></div><div class="weui-actionsheet__cell"paycode="2081"><img class="icon-pay"src="/mobiedit/wx/img/pay/alipay.png"><span class="pay-title">&nbsp;支付宝支付</span></div><div class="weui-actionsheet__cell"paycode="2080"><img class="icon-pay"src="/mobiedit/wx/img/pay/cardPay.png"><span class="pay-title">&nbsp;制作卡支付</span></div></div><div class="weui-actionsheet__action"><div class="weui-actionsheet__cell reset">取消</div></div></div></div>',t='<div id="J_card-pay"class="js_dialog card-pay"style="opacity: 1;"><div class="weui-mask"></div><div class="weui-dialog"><div class="weui-dialog__hd"><strong class="weui-dialog__title"></strong></div><div class="weui-dialog__bd"><div class="weui-cell"><div class="weui-cell__hd"><label class="weui-label">制作卡</label></div><div class="weui-cell__bd"><input class="weui-input"name="couponno"type="text"placeholder="输入6位或8位卡密码"></div></div><div class="weui-cell"><div class="weui-cell__hd"><label class="weui-label">验证码</label></div><div class="weui-cell__bd"><input class="weui-input"name="randno"type="text"placeholder="输入验证码"></div><div class="weui-cell__ft"><img class="weui-vcode-img"src="/wx/image.do"></div></div></div><div class="weui-dialog__ft"><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_default">取消</a><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_primary">确定支付</a></div></div></div>',s='<div id="J_card-pay-result"class="js_dialog card-pay"style="opacity: 1;"><div class="weui-mask"></div><div class="weui-dialog"><div class="weui-dialog__hd"><strong class="weui-dialog__title">是否确认支付</strong></div><div class="weui-dialog__bd"></div><div class="weui-dialog__ft"><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_default">取消</a><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_primary">确定支付</a></div></div></div>',n='<div class="js_dialog card-pay"style="opacity: 1;"><div class="weui-mask"></div><div class="weui-dialog"><div class="weui-dialog__hd"><strong class="weui-dialog__title"></strong></div><div class="weui-dialog__bd"></div><div class="weui-dialog__ft"><a href="javascript:;"class="weui-dialog__btn weui-dialog__btn_primary">确定</a></div></div></div>';return e.fn=e.prototype,e.fn.init=function(i){var e=this;a.Loading.show("加载中"),a.ajax.postJSON("/ci/wx/order/createOrder",{sitecode:i},function(d){if(a.Loading.hide(),200===d.ecode){var l=d.data;console.info(l),e.paypicker=new o({pickerTpl:c,hideback:function(){}}),e.paypicker.show();var r=e.paypicker.getCurDom(),u=l.ordercode,w=l.payamountprice;r.find(".select-btns").on("click",".weui-actionsheet__cell",function(){var o=$(this).attr("paycode");if("2081"==o)window.location.href="/wx/pay/topay.do?paywaycode="+o+"&ordercode="+u;else if("2082"==o)a.isWeixin()?a.ajax.postJSON("/ci/wx/pay/toWechatPay",{ordercode:u,paywaycode:o},function(i){if(200===i.ecode){var e=i.data;wx.ready(function(){wx.chooseWXPay({timestamp:e.timeStamp,nonceStr:e.nonceStr,package:e.prepay,signType:"MD5",paySign:e.sign,success:function(i){location.href="/wx/wappay/wechat/result.do?paydetailcode="+e.paydetailcode},fail:function(i){console.info(i)}})})}else a.Toast.show("info",i.msg)}):window.location.href="/wx/pay/topay.do?paywaycode="+o+"&ordercode="+u;else if("2080"==o){var c=$(t);e.paypicker.hide(),c.find(".weui-dialog__btn_default").on("click",function(){c.remove()}),c.find(".weui-dialog__btn_primary").on("click",function(){var e=c.find("input[name='couponno']").val();e=e.replace(/(^\s*)|(\s*$)/g,"");var o=c.find("input[name='randno']").val();if(e){var t=/^[0-9]{6,8}$/;if(t.test(e)){var d=/^[a-zA-Z0-9]{4}$/;if(!o)return void a.Toast.show("info","验证码不能为空!");if(!d.test(o))return void a.Toast.show("info","验证码错误!");a.ajax.getJSON("/ci/wx/order/queryCoupon",{couponno:e,randno:o,ordercode:u},function(t){if(200===t.ecode){var d=t.data.denomination;if(d<w){var l=$(n);c.remove(),$("body").append(l);var r='对不起，您的制作码面额是：<span class="money">'+d+"</span>元，小于订单金额，不足以支付！";l.find(".weui-dialog__bd").html(r),l.find(".weui-dialog__btn_primary").on("click",function(){l.remove()})}else{var p=$(s);c.remove(),$("body").append(p),p.find(".weui-dialog__bd").html('您的制作码面额是：<span class="money"> '+d+"</span>元，<br/> 是否确认支付?"),p.find(".weui-dialog__btn_primary").on("click",function(){a.ajax.postJSON("/ci/wx/order/payCoupon",{couponno:e,ordercode:u,sitecode:i,randno:o},function(e){200===e.ecode?(a.Toast.show("success","恭喜，支付成功"),p.remove(),setTimeout(function(){window.location.href="/wx/pay/result.do?sitecode="+i},2e3)):(a.Toast.show("info",e.msg),p.remove())})}),p.find(".weui-dialog__btn_default").on("click",function(){p.remove()})}}else c.find(".weui-vcode-img").trigger("click"),a.Toast.show("info",t.msg)})}else a.Toast.show("info","制作码错误")}else a.Toast.show("info","制作码不能为空")}),c.find(".weui-vcode-img").on("click",function(){$(this).attr("src","/wx/image.do?"+Math.random())}),c.find("input").keydown(function(i){13===i.keyCode&&c.find(".weui-dialog__btn_primary").trigger("click")}),$("body").append(c)}})}})},new e}),seajs.use(isDebug?"/tpl/ylcom":"ylcom",function(i){seajs.config(i.getComsLibSeajsConf("//"+location.host+"/tpl/")),seajs.use(isDebug?"/tpl/pageInit":"/tpl/dist/pageInit.min",function(i){seajs.use(["cases/createSite"],function(i){i.init()})})});