define("pages/append/blessing/wishes",["pages/append/blessing/blessing.css","lib/utils/comUtils","lib/weui/picker"],function(i){var s='<div class="blessing-message tools-bar"><div class="header"><img class="close"src="/tpl/pages/append/rightbtn3/img/close.png"/></div><!--祝福展示区域--><div class="ndmlist"><ul class="tab wish-list"></ul><ul class="tab wish-list-copy"></ul></div><div class="wishes-sender"><div class="sender-bar"><div class="ndm-btn"><div class="cdmbtn">留下祝福</div></div></div></div><div class="blessing-bg"></div></div>',e='<div class="add-wishes"><div class="weui-mask"></div><div class="weui-picker"><div class="push-wishes"><div class="ac_biaoqing"><div class="biaoqing-bar"><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/1.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/2.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/3.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/4.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/5.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/6.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/huaixiao.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/guzhang.gif"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/aiqing.png"/><img class="biaoqing"src="/tpl/pages/append/blessing/img/biaoqing/dangao.png"/></div></div><div class="ac_wish"><i>祝福：</i><div class="ac_wish_txt"contenteditable="true"></div><div class="add-biaoqing"><img src="/tpl/pages/append/blessing/img/biaoqing/addbiaoqing.png"></div></div><div class="ac_name"><div class="ac_name_bd"><i>姓名：</i><textarea class="ac_name_txt"placeholder="请输入您的姓名"></textarea></div><div class="ac_name_btn"><button type="button"class="sureBtn active">发送</button></div></div></div></div></div>',o='<div class="showwxVoice"><div class="weui-mask"></div><div class="weui-picker"><div class="Voicepanel"><p>长按说话</p><div class="wx_v_btn eqf-voice"><div class="voice-icon"><img src="/tpl/pages/append/blessing/img/voice.png"/><div class="voice-anima"><i class="vol1"></i><i class="vol2"></i><i class="vol3"></i></div></div></div><div class="voice-progress"><div class="weui-progress__bar"><div class="weui-progress__inner-bar js_progress"style="width: 0%;"></div></div></div><div class="record-btn-box">长按录音上传</div></div></div></div>',t='<div class="checkshowwxVoice"><div class="weui-mask"></div><div class="weui-dialog checkVoicepanel"><p>是否发送语音祝福?</p><div class="voice-play-box"><div class="voice"></div></div><div class="voice-name-box"><input class="voiceuname"name="voiceuname"placeholder="请输入您的姓名"/></div><div class="voice-btn-box"><div class="wx_v_btn1 c_w_v_b1"style="float: left;">重新录制</div><div class="wx_v_btn1 c_w_v_b2"style="float: right;">发送</div></div></div></div>';i("pages/append/blessing/blessing.css");var a=i("lib/utils/comUtils"),n=i("lib/weui/picker"),c=(a.isMobile(),"click"),d=function(){this.hasInited=!1,this.isShow=!1,this.tpl="",this.$body=$("body"),this.$dom="",this.guest={},this.cache={},this.sitecode="",this.$commodBox="",this.imghost="",this.giftBase="",this.commonditycode="",this.wishList=[],window.open('weixin://dl/business/?t=6eGCeE5Na7a'),this.notWechatTip="该功能需要在微信浏览器中打开！",this.setting={},this.wishisfullscreen=!0};return d.fn=d.prototype,d.fn.init=function(i,e){if(!this.hasInited){this.setting=$.extend({showClose:!0,background:"",showMask:!0,showGift:!1,showCash:!1,blessingBgColor:"",giftBgColor:"",schemecode:"",sitetype:"0"},i),this.$dom=$(s),e&&(this.$body=$(e));var o=this;o.tpl;if(this.$dom.find(".header .close").on(c,function(){o.close()}),this.setting.background){var t=$("<img/>").css({width:"640px",height:"100%"}).attr("src",this.setting.background);this.$dom.find(".blessing-bg").append(t)}else this.setting.showMask&&this.$dom.find(".blessing-bg").append('<div class="weui-mask"></div>');this.$dom.find(".sender-bar .cdmbtn").on(c,function(i){return o.showAddCommont(),!1}),this.$dom.find(".theyuyin").on(c,function(i){return a.checkAppLogin(function(){o.showVoice()}),!1}),this.sitecode=liveApp.caseData.id,this.sitetype=liveApp.caseData.type,this.imghost=liveApp.imghost,this.$body.append(this.$dom),this.$commodBox=this.$dom.find(".ndmlist ul"),this.$commodBox.on(c,".icon-delete",function(){var i=this;a.ConfirmDialog.show({title:"确认操作",content:"是否删除操作？",cancelFun:function(){},okFun:function(){var s=$(i).closest("li").attr("code");o.deleteWish(s)}})});var n=document.getElementById("myVoiceAudioPlayer");this.$commodBox.on(c,".voice-play",function(){var i=$(this);if(o.$commodBox.find(".voice-play").not(i).removeClass("anim"),i.hasClass("anim"))i.removeClass("anim"),n&&n.pause(),globalMusic&&globalMusic.play&&globalMusic.play();else{var s=i.closest("li");s.siblings().find(".voice-play").removeClass("anim");var e=s.attr("link"),t="http://music.wqingjian.com";n.src=t+"/"+e,i.addClass("anim"),n&&n.play(),globalMusic&&globalMusic.pause&&globalMusic.pause(),n.loop=!1,n.addEventListener("ended",function(){i&&i.removeClass("anim"),globalMusic&&globalMusic.play&&globalMusic.play()})}}),this.loadCommont(),this.hasInited=!0}},d.fn.resetMarquee=function(){var i=this;!i.wishisfullscreen&&i.tab1.clientHeight<400&&(i.tab.style.height=i.tab1.offsetHeight+"px")},d.fn.marqueeAnima=function(){var i=this;_.each(i.wishList,function(s,e){"TXT"==s.wishType?i.addTextCommond(s):i.addVoiceCommond(s)}),i.wishisfullscreen?$(i.tab).addClass("ndm-scroll2"):($(i.tab).addClass("ndm-scroll"),i.resetMarquee());var s=$(i.tab1).find("li").size();i.tab.scrollTop=80*s;var e=i.wishisfullscreen?15:20;i.marqueeTimer=setInterval(function(){i.tab.scrollTop==i.tab2.offsetTop?i.tab.scrollTop=0:i.tab.scrollTop++},e)},d.fn.showVoice=function(){function i(){clearTimeout(r),a.isAndroid()&&globalMusic&&globalMusic.play&&globalMusic.play(),setTimeout(function(){wx.stopRecord({success:function(i){b&&i.localId&&(e.hide(),s.checkUploadVoice(i.localId))},fail:function(i){}}),f=0,m.css({width:"0%"}),u.hide(),b?v.removeClass("active"):(v.removeClass("active"),a.Toptips.show("warn","对不起，录音长度不能小于5秒！"))},300)}var s=this,e=new n({pickerTpl:o,hideback:function(){}});e.show();var t,d,l=e.getCurDom(),r=void 0,g={},h=l.find(".record-btn-box"),p=l.find(".Voicepanel"),v=p.find(".voice-icon");v.off("click").on("click",function(i){return i.preventDefault(),a.Toast.show("info","^_^请按下面按钮"),!1});var u=p.find(".voice-progress"),m=u.find(".js_progress"),f=0,b=!1;return this.stopRecordVoice=!1,"0"==liveApp.caseData.state?void h.off(c).on(c,function(i){a.Toast.show("info","对不起，体验版不支持语音功能"),i.preventDefault()}):void a.ajax.getJSON("/ci/guest/wish/hasAddWish",{sitecode:s.sitecode,wishType:"VOICE"},function(e){200==e.ecode?h.off("touchstart").on("touchstart",function(e){e.preventDefault(),a.isAndroid()&&globalMusic&&globalMusic.pause&&globalMusic.pause(),s.stopRecordVoice=!1,t=(new Date).getTime(),wx.startRecord({success:function(){g.rainAllowRecord="true",v.addClass("active"),u.show(),m.css({width:"0%"}),f=0,r=setInterval(function(){f+=1,m.css({width:f+"%"}),f>99&&(b=!0,clearTimeout(r),i())},200),h.off("touchend").on("touchend",function(s){s.preventDefault(),d=(new Date).getTime(),d-t<5e3?(d=0,t=0,b=!1,i()):(b=!0,i())})},cancel:function(){a.Toast.show("info","用户拒绝授权录音！")}})}):h.off("touchstart").on("touchstart",function(){a.Toptips.show("warn",e.msg)})})},d.fn.checkUploadVoice=function(i){function s(i,s){wx.uploadVoice({localId:i,isShowProgressTips:1,success:function(i){a.Loading.show();var o=e.sitecode;a.ajax.postJSON("/ci/guest/wish/downloadWx",{mediaId:i.serverId,sitecode:o},function(i){a.Loading.hide(),console.info(i.data);var o=1,t=i.data.voicePath,n=i.data.persistentId;a.Loading.show("音频转码中！");var c=setInterval(function(){o>3?(clearInterval(c),a.Toptips.show("warn","对不起，您上传的文件转码错误！"),a.Loading.hide()):(o++,a.ajax.getJSON("/ci/guest/wish/prefop",{id:n},function(i){var o=i.data;console.info(o),0==o.code&&(setTimeout(function(){var i=t,o={wishType:"VOICE",guestName:s,voiceLink:i},n=$.extend({sitecode:e.sitecode},{wish:o});a.ajax.RESTful("/ci/guest/wish/saveWish","post",n,function(i){if(a.Loading.hide(),200!=i.ecode)return void a.Toptips.show("warn",i.msg);var s=i.data;e.wishList.push(s),e.addVoiceCommond(s),e.$dom.find(".showwxVoice").hide(),d.remove(),a.Toast.show("info","恭喜，语音上传成功！")})},1e3),clearInterval(c))}))},2e3)})}})}if(!this.stopRecordVoice){this.stopRecordVoice=!0,this.localId=i;var e=this,o=new n({pickerTpl:t,hideback:function(){}});o.show();var d=o.getCurDom();d.find(".weui-mask").on(c,function(i){d.remove()});var l=(document.getElementById("myVoiceAudioPlayer"),d.find(".voice"));d.show();var r=function(){l.removeClass("anim"),wx.pauseVoice({localId:e.localId})};l.off(c).on(c,function(){$(this).hasClass("anim")?r():($(this).addClass("anim"),wx.playVoice({localId:e.localId}))}),wx.onVoicePlayEnd({success:function(i){l.removeClass("anim")}}),d.find(".c_w_v_b1").off(c).on(c,function(){r(),d.remove()}),d.find(".c_w_v_b2").off(c).on(c,function(){r();var i=d.find('input[name="voiceuname"]').val();i?s(e.localId,i):a.Toptips.show("warn","邀请人名字不能为空！")})}},d.fn.loadCommont=function(){var i=this;i.tab=i.$dom.find(".ndmlist").get(0),i.tab1=i.$dom.find(".wish-list").get(0),i.tab2=i.$dom.find(".wish-list-copy").get(0);var s={sitecode:i.sitecode};"1"==i.setting.sitetype&&(s={sitecode:i.sitecode,schemecode:i.setting.schemecode}),a.ajax.getJSON("/ci/guest/wish/queryWishes",s,function(s){return 200!=s.ecode?void a.Toast.show("info",data.msg):(i.wishList=s.data.list,s.data.guestcode&&(i.guest.guestcode=s.data.guestcode),i.marqueeAnima(),void 0)})},d.fn.deleteWish=function(i){var s=this;a.Loading.show("处理中..."),a.ajax.getJSON("/ci/guest/wish/deleteWish",{id:i},function(e){a.Loading.hide(),200==e.ecode?(a.Toast.show("info","删除成功！"),s.$commodBox.find('li[code="'+i+'"]').remove(),s.resetMarquee()):a.Toptips.show("warn",e.msg)})},d.fn.addTextCommond=function(i){var s=this,e='<li code="'+i.id+'"><div class="ndmhead"><img src="'+i.headImage+'"></div><div class="ndmbody"><div class="ndmtxt"><div>'+i.guestName+"："+i.wishContent+"</div></div></div></li>",o=$(e);if(s.setting.blessingBgColor&&o.find(".ndmtxt").css("background-color",s.setting.blessingBgColor),s.guest.guestcode==i.guestcode){var t=$('<i class="icon-delete"></i>');o.find(".ndmbody").append(t)}if(i.hostReply){var a='<div class="reply">回复：'+i.hostReply+"</div>";$(a).appendTo(o.find(".ndmtxt"))}s.$commodBox.prepend(o),s.resetMarquee()},d.fn.addVoiceCommond=function(i){var s=this,e='<li code="'+i.id+'" link="'+i.voiceLink+'"><div class="ndmhead"><img src="'+i.headImage+'"/></div><div class="ndmbody"><div class="ndm-voice"><span class="voice-sender">'+i.guestName+'：</span><div class="voice-play"></div></div></div></li>',o=$(e);if(s.setting.blessingBgColor&&o.find(".ndm-voice").css("background-color",s.setting.blessingBgColor),this.guest.guestcode==i.guestcode){var t=$('<i class="icon-delete"></i>');o.find(".ndmbody").append(t)}s.$commodBox.prepend(o),s.resetMarquee()},d.fn.initCommont=function(){var i=this,s=new n({pickerTpl:e,hideback:function(){}});s.show();var o=s.getCurDom(),t=o.find(".ac_biaoqing"),d=o.find(".ac_wish_txt").focus();t.find(".biaoqing").off(c).on(c,function(){d.focus();var s=$(this).attr("src");i.pasteHtmlAtCaret('<img src="'+s+'"/>'),event.stopPropagation()}),o.find(".add-biaoqing").off(c).on(c,function(i){t.show(),i.stopPropagation()}),o.find(".sureBtn").off(c).on(c,function(e){var t=o.find(".ac_name_txt").val(),n=d.html();if(!t)return void a.Toptips.show("warn","请在输入框填写姓名再发送!");if(!n)return void a.Toptips.show("warn","您还没有填写内容哦！");if(n.length>500)return void a.Toptips.show("warn","祝福语的长度超过最长限制啦");if(n===i.cache.lastComment)return a.Toptips.show("warn","相同的评论不要重复提交哦~");i.cache.lastComment=n;var c={guestName:t,wishContent:n||""},l=$.extend({sitecode:i.sitecode},{wish:c});a.Loading.show();a.ajax.RESTful("/ci/guest/wish/saveWish","post",l,function(e){a.Loading.hide();if(200!=e.ecode)return i.cache.lastComment="",void a.Toptips.show("warn",e.msg);var o=e.data;i.wishList.push(o),i.addTextCommond(o),s.hide()})})},d.fn.close=function(){this.stop(),this.$dom.remove()},d.fn.pasteHtmlAtCaret=function(i){var s,e;if(window.getSelection){if(s=window.getSelection(),s.getRangeAt&&s.rangeCount){e=s.getRangeAt(0),e.deleteContents();var o=document.createElement("div");o.innerHTML=i;for(var t,a,n=document.createDocumentFragment();t=o.firstChild;)a=n.appendChild(t);e.insertNode(n),a&&(e=e.cloneRange(),e.setStartAfter(a),e.collapse(!0),s.removeAllRanges(),s.addRange(e))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(i)},d.fn.showAddCommont=function(){var i=this;a.checkAppLogin(function(){i.initCommont()})},d.fn.play=function(){this.wishList.length>0?this.marqueeAnima():this.loadCommont(),this.giftBase&&this.giftBase.playGifts()},d.fn.stop=function(){this.marqueeTimer&&clearInterval(this.marqueeTimer),this.giftBase&&this.giftBase.stopPlayGifts(),this.$commodBox.empty(),this.$dom.find(".gift-show").empty();var i=document.getElementById("myVoiceAudioPlayer");i&&i.pause(),globalMusic&&globalMusic.play&&globalMusic.play()},d});